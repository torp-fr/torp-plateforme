{
  "name": "TORP Devis Analysis Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "torp-trigger",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/webhook-n8n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "action", "value": "list-pending" },
            { "name": "webhookSecret", "value": "={{ $env.N8N_WEBHOOK_SECRET }}" },
            { "name": "payload", "value": "={{ JSON.stringify({ limit: 5 }) }}" }
          ]
        }
      },
      "id": "get-pending-devis",
      "name": "Get Pending Devis",
      "type": "n8n-nodes-base.httpRequest",
      "position": [450, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-devis",
      "name": "Split Devis",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/extract-pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "storagePath", "value": "={{ $json.fichier_url }}" }
          ]
        }
      },
      "id": "extract-pdf",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/scrape-enterprise",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "siret", "value": "={{ $json.siret || '' }}" },
            { "name": "name", "value": "={{ $json.enterpriseName || '' }}" }
          ]
        }
      },
      "id": "scrape-enterprise",
      "name": "Scrape Enterprise",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 100]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/scrape-prices",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "devisText", "value": "={{ $node['Extract PDF Text'].json.text }}" }
          ]
        }
      },
      "id": "scrape-prices",
      "name": "Compare Prices",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/scrape-regulations",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "devisText", "value": "={{ $node['Extract PDF Text'].json.text }}" }
          ]
        }
      },
      "id": "scrape-regulations",
      "name": "Check Aids & Regulations",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-data",
      "name": "Merge Scraper Data",
      "type": "n8n-nodes-base.merge",
      "position": [1250, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/analyze-devis",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "devisText", "value": "={{ $node['Extract PDF Text'].json.text }}" },
            { "name": "devisId", "value": "={{ $node['Split Devis'].json.id }}" },
            { "name": "enterpriseData", "value": "={{ JSON.stringify($node['Scrape Enterprise'].json) }}" },
            { "name": "priceComparison", "value": "={{ JSON.stringify($node['Compare Prices'].json) }}" },
            { "name": "aidsData", "value": "={{ JSON.stringify($node['Check Aids & Regulations'].json) }}" }
          ]
        }
      },
      "id": "analyze-torp",
      "name": "TORP Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.analysis?.scores?.total }}",
              "operation": "largerEqual",
              "value2": 700
            }
          ]
        }
      },
      "id": "check-score",
      "name": "Score >= 700?",
      "type": "n8n-nodes-base.if",
      "position": [1650, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/webhook-n8n",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "action", "value": "notify" },
            { "name": "webhookSecret", "value": "={{ $env.N8N_WEBHOOK_SECRET }}" },
            { "name": "payload", "value": "={{ JSON.stringify({ type: 'approved', devisId: $node['Split Devis'].json.id, score: $json.analysis.scores.total, aids: $node['Check Aids & Regulations'].json.analysis?.eligibleAids }) }}" }
          ]
        }
      },
      "id": "notify-approved",
      "name": "Notify Approved",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1850, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/webhook-n8n",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "action", "value": "notify" },
            { "name": "webhookSecret", "value": "={{ $env.N8N_WEBHOOK_SECRET }}" },
            { "name": "payload", "value": "={{ JSON.stringify({ type: 'review_needed', devisId: $node['Split Devis'].json.id, score: $json.analysis.scores.total, issues: $json.analysis?.warnings }) }}" }
          ]
        }
      },
      "id": "notify-review",
      "name": "Notify Review Needed",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1850, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, processed: $node['Split Devis'].json.id, analysis: $node['TORP Analysis'].json } }}"
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [2050, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": { "main": [[{ "node": "Get Pending Devis", "type": "main", "index": 0 }]] },
    "Get Pending Devis": { "main": [[{ "node": "Split Devis", "type": "main", "index": 0 }]] },
    "Split Devis": { "main": [[{ "node": "Extract PDF Text", "type": "main", "index": 0 }]] },
    "Extract PDF Text": {
      "main": [
        [
          { "node": "Scrape Enterprise", "type": "main", "index": 0 },
          { "node": "Compare Prices", "type": "main", "index": 0 },
          { "node": "Check Aids & Regulations", "type": "main", "index": 0 }
        ]
      ]
    },
    "Scrape Enterprise": { "main": [[{ "node": "Merge Scraper Data", "type": "main", "index": 0 }]] },
    "Compare Prices": { "main": [[{ "node": "Merge Scraper Data", "type": "main", "index": 1 }]] },
    "Check Aids & Regulations": { "main": [[{ "node": "Merge Scraper Data", "type": "main", "index": 2 }]] },
    "Merge Scraper Data": { "main": [[{ "node": "TORP Analysis", "type": "main", "index": 0 }]] },
    "TORP Analysis": { "main": [[{ "node": "Score >= 700?", "type": "main", "index": 0 }]] },
    "Score >= 700?": {
      "main": [
        [{ "node": "Notify Approved", "type": "main", "index": 0 }],
        [{ "node": "Notify Review Needed", "type": "main", "index": 0 }]
      ]
    },
    "Notify Approved": { "main": [[{ "node": "Respond", "type": "main", "index": 0 }]] },
    "Notify Review Needed": { "main": [[{ "node": "Respond", "type": "main", "index": 0 }]] }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
